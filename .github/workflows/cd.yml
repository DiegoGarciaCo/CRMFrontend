name: cd
on:
  push:
    branches: [main]
jobs:
  build-and-push:
    name: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: set up node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: install deps
        run: npm ci

      - name: build app
        env:
          BASE_URL: ${{ secrets.BASE_URL}}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET}}
          BETTER_AUTH_URL: ${{ secrets.BETTER_AUTH_URL}}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID}}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET}}
          APPLE_CLIENT_ID: ${{ secrets.APPLE_CLIENT_ID}}
          APPLE_CLIENT_SECRET: ${{ secrets.APPLE_CLIENT_SECRET}}
          APPLE_APP_BUNDLE_IDENTIFIER: ${{ secrets.APPLE_APP_BUNDLE_IDENTIFIER}}
          NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL}}
          NEXT_PUBLIC_BETTER_AUTH_URL: ${{ secrets.NEXT_PUBLIC_BETTER_AUTH_URL}}
          DATABASE_URL: ${{ secrets.DATABASE_URL}}
          POSTMARK_SERVER_TOKEN: ${{ secrets.POSTMARK_SERVER_TOKEN}}
          POSTMARK_FROM_EMAIL: ${{ secrets.POSTMARK_FROM_EMAIL}}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET}}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY}}
          COOKIE_DOMAIN: ${{ secrets.COOKIE_DOMAIN}}
        run: npm run build

      - name: login to docker hub
        uses: docker/login-action@v3
        with:
          username: ${{vars.DOCKERHUB_USERNAME}}
          password: ${{secrets.DOCKERHUB_TOKEN}}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: dgarcia51/crm:${{ github.sha }},dgarcia51/crm:latest
          secrets: |
            "BASE_URL=${{ secrets.BASE_URL}}"
            "BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET}}"
            "BETTER_AUTH_URL=${{ secrets.BETTER_AUTH_URL}}"
            "NEXT_PUBLIC_BASE_URL=${{ secrets.NEXT_PUBLIC_BASE_URL}}"
            "NEXT_PUBLIC_BETTER_AUTH_URL=${{ secrets.NEXT_PUBLIC_BETTER_AUTH_URL}}"
            "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID}}"
            "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET}}"
            "APPLE_CLIENT_ID=${{ secrets.APPLE_CLIENT_ID}}"
            "APPLE_CLIENT_SECRET=${{ secrets.APPLE_CLIENT_SECRET}}"
            "APPLE_APP_BUNDLE_IDENTIFIER=${{ secrets.APPLE_APP_BUNDLE_IDENTIFIER}}"
            "POSTMARK_SERVER_TOKEN=${{ secrets.POSTMARK_SERVER_TOKEN }}"
            "POSTMARK_FROM_EMAIL=${{ secrets.POSTMARK_FROM_EMAIL}}"
            "DATABASE_URL=${{ secrets.DATABASE_URL}}"
            "STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET}}"
            "STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY}}"
            "COOKIE_DOMAIN=${{ secrets.COOKIE_DOMAIN}}"

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
      - build-and-push
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: soldbyghost.com
          username: ghost
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Create working directory
            mkdir -p ~/crm
            cd ~/crm

            # Create docker-compose.yml
            cat > docker-compose.yml << 'COMPOSE_EOF'
            services:
              app:
                image: dgarcia51/crm:latest
                ports:
                  - "3010:3010"
                environment:
                  - PORT=${PORT}
                  - NODE_ENV=${NODE_ENV}
                  - DATABASE_URL=${DATABASE_URL}
                  - BASE_URL=${BASE_URL}
                  - NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL}
                  - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
                  - BETTER_AUTH_URL=${BETTER_AUTH_URL}
                  - NEXT_PUBLIC_BETTER_AUTH_URL=${NEXT_PUBLIC_BETTER_AUTH_URL}
                  - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
                  - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
                  - APPLE_CLIENT_ID=${APPLE_CLIENT_ID}
                  - APPLE_CLIENT_SECRET=${APPLE_CLIENT_SECRET}
                  - APPLE_APP_BUNDLE_IDENTIFIER=${APPLE_APP_BUNDLE_IDENTIFIER}
                  - POSTMARK_SERVER_TOKEN=${POSTMARK_SERVER_TOKEN}
                  - POSTMARK_FROM_EMAIL=${POSTMARK_FROM_EMAIL}
                  - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
                  - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
                  - COOKIE_DOMAIN=${COOKIE_DOMAIN}
                deploy:
                  replicas: 3
                  update_config:
                    parallelism: 1
                    delay: 10s
                    failure_action: rollback
            COMPOSE_EOF

            # Export environment variables
            export PORT=3010
            export NODE_ENV=production
            export DATABASE_URL="${{ secrets.DATABASE_URL }}"
            export BASE_URL="${{ secrets.BASE_URL }}"
            export BETTER_AUTH_SECRET="${{ secrets.BETTER_AUTH_SECRET }}"
            export BETTER_AUTH_URL="${{ secrets.BETTER_AUTH_URL }}"
            export NEXT_PUBLIC_BASE_URL="${{ secrets.NEXT_PUBLIC_BASE_URL }}"
            export NEXT_PUBLIC_BETTER_AUTH_URL="${{ secrets.NEXT_PUBLIC_BETTER_AUTH }}"
            export GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
            export GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"
            export APPLE_CLIENT_ID="${{ secrets.APPLE_CLIENT_ID }}"
            export APPLE_CLIENT_SECRET="${{ secrets.APPLE_CLIENT_SECRET }}"
            export APPLE_APP_BUNDLE_IDENTIFIER="${{ secrets.APPLE_APP_BUNDLE_IDENTIFIER }}"
            export POSTMARK_SERVER_TOKEN="${{ secrets.POSTMARK_SERVER_TOKEN }}"
            export POSTMARK_FROM_EMAIL="${{ secrets.POSTMARK_FROM_EMAIL }}"
            export STRIPE_WEBHOOK_SECRET="${{ secrets.STRIPE_WEBHOOK_SECRET }}"
            export STRIPE_SECRET_KEY="${{ secrets.STRIPE_SECRET_KEY }}"
            export COOKIE_DOMAIN="${{ secrets.COOKIE_DOMAIN }}"

            # Deploy stack
            docker stack deploy -c docker-compose.yml crm

            # Show status
            echo "Deployment complete!"
            docker stack ps crm
